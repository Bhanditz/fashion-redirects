#!/usr/bin/env ruby
# frozen_string_literal: true

require 'cgi'
require 'net/http'
require 'json'
require 'mongo'

unless ENV.key?('API_KEY') && ENV.key?('MONGO_URI')
  puts 'Error: API_KEY and MONGO_URI env vars are required.'
  exit 1
end

API_URL = 'https://www.europeana.eu/api/v2'
api_key = ENV['API_KEY']

# e.g. MONGO_URI="mongodb://127.0.0.1:27017/fashion"
client = Mongo::Client.new(ENV['MONGO_URI'])
collection = client[:redirects]
collection.indexes.create_one({ fashion_hash: 1 }, unique: true)

cursor = '*'
i = 0

while !cursor.nil?
  cgi_cursor = CGI.escape(cursor)
  uri = URI.parse("#{API_URL}/search.json")
  uri.query = "wskey=#{api_key}&query=PROVIDER:\"Europeana Fashion\"&rows=100&profile=minimal&cursor=#{cgi_cursor}"
  puts uri.to_s
  http = Net::HTTP.new(uri.host, uri.port)
  http.use_ssl = true if uri.scheme == 'https'
  request = Net::HTTP::Get.new(uri.request_uri)
  response = http.request(request)
  results = JSON.parse(response.body)
  break unless results.key?('items')
  results['items'].each do |item|
    i = i + 1
    id = item['id']
    redirect_uri = URI.parse(item['edmIsShownAt'].first)
    edm_is_shown_at_uri = URI.parse(CGI.parse(redirect_uri.query)['shownAt'].first)
    hash = edm_is_shown_at_uri.path.split('/').last
    puts "[#{i}] #{hash} => #{id}"
    collection.insert_one({ fashion_hash: hash, europeana_id: id })
  end
  cursor = results['nextCursor']
end

client.close
