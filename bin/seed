#!/usr/bin/env ruby
# frozen_string_literal: true

require 'cgi'
require 'net/http'
require 'json'
require 'pg'

unless ENV.key?('API_KEY') && ENV.key?('DATABASE_URL')
  puts 'Error: API_KEY and DATABASE_URL env vars are required.'
  exit 1
end

API_URL = 'https://www.europeana.eu/api/v2'
api_key = ENV['API_KEY']

pg = PG.connect(ENV['DATABASE_URL'])

cursor = '*'
i = 0

while !cursor.nil?
  cgi_cursor = CGI.escape(cursor)
  uri = URI.parse("#{API_URL}/search.json")
  uri.query = "wskey=#{api_key}&query=PROVIDER:\"Europeana Fashion\"&rows=100&profile=minimal&cursor=#{cgi_cursor}"
  puts uri.to_s
  http = Net::HTTP.new(uri.host, uri.port)
  http.use_ssl = true if uri.scheme == 'https'
  request = Net::HTTP::Get.new(uri.request_uri)
  response = http.request(request)
  results = JSON.parse(response.body)
  break unless results.key?('items')
  results['items'].each do |item|
    i = i + 1
    id = item['id']
    redirect_uri = URI.parse(item['edmIsShownAt'].first)
    edm_is_shown_at_uri = URI.parse(CGI.parse(redirect_uri.query)['shownAt'].first)
    src = edm_is_shown_at_uri.path
    dst = "/portal/record#{id}.html"
    puts "[#{i}] #{src} => #{dst}"
    pg.exec_params('INSERT INTO public.redirects (src, dst, site) VALUES ($1, $2, $3)', [src, dst, 'portal'])
  end
  cursor = results['nextCursor']
end

pg.close
